<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ â€” Cadastro de Produto</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div class="app-container">
    <button id="btnMenu" class="hamburger">â˜°</button>
    <aside class="sidebar" id="sidebarMenu">
      <h1></h1>
      <nav>
        <a href="dashboard.html">Painel</a>
        <a href="#" class="active">Cadastrar Produto</a>
        <a href="Lista-produtos.html">Lista de Produtos</a>
        <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
        <a href="calendario.html">CalendÃ¡rio</a>
        <a href="perfil.html">Perfil</a>
        <a href="cadastro-usuarios.html">Cadastrar UsuÃ¡rios</a>
        <a href="relatorios.html">RelatÃ³rios</a>
        <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
      </nav>
    </aside>

<style>
.hamburger {
  display: none;
  position: fixed;
  top: 15px;
  left: 15px;
  font-size: 28px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  z-index: 9999;
  cursor: pointer;
}

@media(max-width: 900px) {
  .hamburger { display: block; }
  .sidebar {
    position: fixed;
    left: -260px;
    top: 0;
    height: 100vh;
    transition: .3s;
    z-index: 9998;
  }
  .sidebar.open {
    left: 0;
  }
  .main {
    margin-left: 0 !important;
  }
}
</style>

    <main class="main">
      <h2 id="tituloPagina" style="text-align:center;">Cadastrar Produto</h2>

      <form id="formProduto" class="form-produto">

        <label>Nome do Produto</label>
        <input type="text" id="nome" required>

        <label>CÃ³digo de Barras</label>
        <div style="display:flex; gap:8px;">
          <input type="text" id="codigo" placeholder="Aguardando leitura..." required style="flex:1;">
          <button type="button" id="btnScan" style="padding:6px 12px;border-radius:6px;background:var(--accent);border:none;cursor:pointer;">ðŸ“· Ler</button>
        </div>

        <video id="scannerPreview" style="display:none;width:260px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.4);"></video>

        <label>Lote</label>
        <input type="text" id="lote" required>

        <!-- CAMPO PREÃ‡O ADICIONADO -->
        <label>PreÃ§o</label>
        <input type="number" id="preco" step="0.01" placeholder="0,00" required>

        <label>Setor</label>
        <select id="setor" required>
          <option value="Mercearia">Mercearia</option>
          <option value="Bebidas">Bebidas</option>
          <option value="Frios">Frios</option>
          <option value="Higiene">Higiene</option>
          <option value="Limpeza">Limpeza</option>
          <option value="AÃ§ougue">AÃ§ougue</option>
        </select>

        <label>Data de Validade</label>
        <input type="date" id="validade" required>

        <label>Foto do Produto</label>
        <div class="foto-area">
          <video id="cameraPreview" autoplay playsinline style="display:none;width:260px;border-radius:8px;border:1px solid rgba(255,255,255,0.3);"></video>
          <img id="previewFoto" style="display:none;width:140px;border-radius:6px;border:1px solid rgba(255,255,255,0.3);" />
          <input type="file" id="foto" accept="image/*" style="display:none;" />

          <button type="button" id="btnOpenCamera">ðŸ“· Abrir CÃ¢mera</button>
          <button type="button" id="btnCapturar" style="display:none;">âœ… Capturar Foto</button>
        </div>

        <button type="submit" class="btnSalvar" id="btnSalvar">Salvar Produto</button>
        <button type="button" id="btnLimpar" class="btnEdit" style="background:#555;border:none;">Limpar Campos</button>

      </form>
    </main>
  </div>

<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>

<script>
// CÃ‚MERA â€“ CORRIGIDA E 100% FUNCIONANDO
let stream;
const cameraPreview = document.getElementById("cameraPreview");
const previewFoto = document.getElementById("previewFoto");
const inputFoto = document.getElementById("foto");
const btnOpenCamera = document.getElementById("btnOpenCamera");
const btnCapturar = document.getElementById("btnCapturar");

// ABRIR CÃ‚MERA
btnOpenCamera.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }, // CORREÃ‡ÃƒO PRINCIPAL
      audio: false
    });

    cameraPreview.srcObject = stream;

    await cameraPreview.play(); // GARANTE videoWidth/videoHeight

    cameraPreview.style.display = "block";
    previewFoto.style.display = "none";
    btnCapturar.style.display = "inline-block";

  } catch (e) {
    alert("Erro ao acessar cÃ¢mera.");
    console.error(e);
  }
};

// CAPTURAR FOTO
btnCapturar.onclick = async () => {
  const w = cameraPreview.videoWidth || 800;
  const h = cameraPreview.videoHeight || 600;

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(cameraPreview, 0, 0, w, h);

  const dataURL = canvas.toDataURL("image/jpeg");

  previewFoto.src = dataURL;
  previewFoto.style.display = "block";

  // Converter foto para Blob (upload)
  const blob = await fetch(dataURL).then(r => r.blob());
  window.fotoBlob = blob; // SALVA A FOTO CAPTURADA

  // Fechar cÃ¢mera apÃ³s captura
  if (stream) stream.getTracks().forEach(t => t.stop());
  cameraPreview.style.display = "none";
  btnCapturar.style.display = "none";
};
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

// DOM references inside module (important: module scope doesn't create implicit globals from IDs)
const nome = document.getElementById('nome');
const codigo = document.getElementById('codigo');
const lote = document.getElementById('lote');
const preco = document.getElementById('preco');
const setor = document.getElementById('setor');
const validade = document.getElementById('validade');
const inputFile = document.getElementById('foto');
const preview = document.getElementById('previewFoto');
const formProduto = document.getElementById('formProduto');
const scanner = document.getElementById('scannerPreview');

const params = new URLSearchParams(location.search);
const produtoId = params.get("id");

onAuthStateChanged(auth, async user => {
  if (!user || !produtoId) return;

  document.getElementById("tituloPagina").textContent = "Editar Produto";
  document.getElementById("btnSalvar").textContent = "Salvar AlteraÃ§Ãµes";

  const snapUser = await getDoc(doc(db, "usuarios", user.email));
  const loja = snapUser.data().loja;

  const prodSnap = await getDoc(doc(db, `lojas/${loja}/produtos/${produtoId}`));
  const p = prodSnap.data();

  nome.value = p.nome;
  codigo.value = p.codigo;
  lote.value = p.lote;
  preco.value = p.preco ?? "";
  setor.value = p.setor;
  validade.value = p.dataValidadeISO;

  preview.src = p.fotoURL;
  preview.style.display = "block";
  document.getElementById("foto").required = false;
});

// SALVAR
formProduto.onsubmit = async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  const snapUser = await getDoc(doc(db, "usuarios", user.email));
  const loja = snapUser.data().loja;

  const nomeProduto = nome.value.trim();
  const codigoProduto = codigo.value.trim();
  const loteProduto = lote.value.trim();
  const precoProduto = parseFloat(preco.value) || 0;
  const setorProduto = setor.value;
  const validadeProduto = validade.value;

  const [yyyy, mm, dd] = validadeProduto.split("-");
  const validadeBR = `${dd}/${mm}/${yyyy}`;

  const id = produtoId || crypto.randomUUID();
  let fotoURLFinal = "";

  // prioridade 1: foto capturada pela cÃ¢mera (window.fotoBlob)
  if (window.fotoBlob) {
    const fotoRef = ref(storage, `produtos/${loja}/${id}.jpg`);
    await uploadBytes(fotoRef, window.fotoBlob);
    fotoURLFinal = await getDownloadURL(fotoRef);
  }
  // prioridade 2: arquivo selecionado via input[type=file]
  else if (inputFile.files.length > 0) {
    const fotoRef = ref(storage, `produtos/${loja}/${id}.jpg`);
    await uploadBytes(fotoRef, inputFile.files[0]);
    fotoURLFinal = await getDownloadURL(fotoRef);
  }
  // prioridade 3: ao editar, mantem a foto atual se nÃ£o enviar nova
  else if (produtoId) {
    const snapProd = await getDoc(doc(db, `lojas/${loja}/produtos/${produtoId}`));
    fotoURLFinal = snapProd.data().fotoURL || "";
  }

  await setDoc(doc(db, `lojas/${loja}/produtos/${id}`), {
    nome: nomeProduto,
    codigo: codigoProduto,
    lote: loteProduto,
    preco: precoProduto,
    setor: setorProduto,
    dataValidadeISO: validadeProduto,
    dataValidadeBR: validadeBR,
    fotoURL: fotoURLFinal,
    status: "normal",
    criadoEm: new Date()
  }, { merge: true });

  location.href = "Lista-produtos.html";
};

// LIMPAR
const btnLimpar = document.getElementById('btnLimpar');
btnLimpar.onclick = () => {
  formProduto.reset();
  preview.style.display = "none";
  scanner.style.display = "none";
  // limpar fotoBlob se existir
  window.fotoBlob = null;
};
</script>

<button id="toggleTheme" class="theme-toggle">ðŸŒ™</button>
<script>
const toggle = document.getElementById("toggleTheme");

function aplicarTema() {
  const tema = localStorage.getItem("temaValitec") || "dark";
  if (tema === "light") {
    document.documentElement.classList.add("light-mode");
    toggle.textContent = "ðŸŒ™";
  } else {
    document.documentElement.classList.remove("light-mode");
    toggle.textContent = "ðŸ”†";
  }
}

toggle.onclick = () => {
  const atual = localStorage.getItem("temaValitec") || "dark";
  const novo = (atual === "dark") ? "light" : "dark";
  localStorage.setItem("temaValitec", novo);
  aplicarTema();
};

aplicarTema();
</script>
<script>
const btnMenu = document.getElementById("btnMenu");
const sidebarMenu = document.getElementById("sidebarMenu");
btnMenu.onclick = () => {
  sidebarMenu.classList.toggle("open");
};
</script>
</body>
</html>
